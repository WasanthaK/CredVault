<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:CredVault.Mobile.ViewModels"
             xmlns:models="clr-namespace:CredVault.Mobile.Models"
             x:Class="CredVault.Mobile.Views.CredentialDetailsPage"
             x:DataType="viewmodels:CredentialDetailsViewModel"
             Title="{Binding Title}">

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsBusy}"
                              IsVisible="{Binding IsBusy}"
                              Color="{StaticResource Primary}"
                              HeightRequest="50"/>

            <!-- Error Message -->
            <Frame IsVisible="{Binding HasError}"
                   BackgroundColor="#FFEBEE"
                   Padding="16"
                   CornerRadius="8">
                <Label Text="{Binding ErrorMessage}"
                       TextColor="#C62828"
                       HorizontalOptions="Center"/>
            </Frame>

            <!-- Credential Content -->
            <VerticalStackLayout IsVisible="{Binding Credential, Converter={StaticResource IsNotNullConverter}}"
                                Spacing="16">

                <!-- Status Badge -->
                <Frame Padding="12"
                       CornerRadius="12"
                       BackgroundColor="{Binding StatusColor}"
                       HasShadow="False"
                       HorizontalOptions="Start">
                    <Label Text="{Binding Credential.Status}"
                           TextColor="White"
                           FontSize="16"
                           FontAttributes="Bold"/>
                </Frame>

                <!-- Credential Type -->
                <Label Text="{Binding Credential.Type}"
                       FontSize="28"
                       FontAttributes="Bold"/>

                <!-- Basic Information Card -->
                <Frame Padding="16"
                       CornerRadius="12"
                       HasShadow="True"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="12">
                        <Label Text="Basic Information"
                               FontSize="18"
                               FontAttributes="Bold"/>

                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="8">
                            <!-- Credential ID -->
                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="ID:"
                                   FontSize="14"
                                   Opacity="0.7"
                                   Margin="0,0,16,0"/>
                            <Label Grid.Row="0" Grid.Column="1"
                                   Text="{Binding Credential.CredentialId}"
                                   FontSize="14"
                                   LineBreakMode="CharacterWrap"/>

                            <!-- Issuer -->
                            <Label Grid.Row="1" Grid.Column="0"
                                   Text="Issuer:"
                                   FontSize="14"
                                   Opacity="0.7"
                                   Margin="0,0,16,0"/>
                            <Label Grid.Row="1" Grid.Column="1"
                                   Text="{Binding Credential.Issuer}"
                                   FontSize="14"
                                   FontAttributes="Bold"/>

                            <!-- Subject -->
                            <Label Grid.Row="2" Grid.Column="0"
                                   Text="Subject:"
                                   FontSize="14"
                                   Opacity="0.7"
                                   Margin="0,0,16,0"
                                   IsVisible="{Binding Credential.Subject, Converter={StaticResource IsNotNullConverter}}"/>
                            <Label Grid.Row="2" Grid.Column="1"
                                   Text="{Binding Credential.Subject}"
                                   FontSize="14"
                                   IsVisible="{Binding Credential.Subject, Converter={StaticResource IsNotNullConverter}}"/>

                            <!-- Issue Date -->
                            <Label Grid.Row="3" Grid.Column="0"
                                   Text="Issued:"
                                   FontSize="14"
                                   Opacity="0.7"
                                   Margin="0,0,16,0"/>
                            <Label Grid.Row="3" Grid.Column="1"
                                   Text="{Binding Credential.IssuedAt, StringFormat='{0:MMMM dd, yyyy}'}"
                                   FontSize="14"/>

                            <!-- Expiration Date -->
                            <Label Grid.Row="4" Grid.Column="0"
                                   Text="Expires:"
                                   FontSize="14"
                                   Opacity="0.7"
                                   Margin="0,0,16,0"
                                   IsVisible="{Binding Credential.ExpiresAt, Converter={StaticResource IsNotNullConverter}}"/>
                            <Label Grid.Row="4" Grid.Column="1"
                                   Text="{Binding Credential.ExpiresAt, StringFormat='{0:MMMM dd, yyyy}'}"
                                   FontSize="14"
                                   TextColor="{Binding IsExpired, Converter={StaticResource BoolToColorConverter}}"
                                   IsVisible="{Binding Credential.ExpiresAt, Converter={StaticResource IsNotNullConverter}}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Claims Card -->
                <Frame Padding="16"
                       CornerRadius="12"
                       HasShadow="True"
                       BorderColor="Transparent"
                       IsVisible="{Binding Claims.Count, Converter={StaticResource CountToBoolConverter}}">
                    <VerticalStackLayout Spacing="12">
                        <Label Text="Claims"
                               FontSize="18"
                               FontAttributes="Bold"/>

                        <CollectionView ItemsSource="{Binding Claims}"
                                       SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodels:ClaimItem">
                                    <Grid ColumnDefinitions="Auto,*" 
                                          RowSpacing="4"
                                          Margin="0,8">
                                        <Label Grid.Column="0"
                                               Text="{Binding Key, StringFormat='{0}:'}"
                                               FontSize="14"
                                               Opacity="0.7"
                                               Margin="0,0,16,0"/>
                                        <Label Grid.Column="1"
                                               Text="{Binding Value}"
                                               FontSize="14"
                                               LineBreakMode="WordWrap"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- QR Code Card -->
                <Frame Padding="16"
                       CornerRadius="12"
                       HasShadow="True"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="12" HorizontalOptions="Center">
                        <Label Text="Present Credential"
                               FontSize="18"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"/>
                        
                        <Label Text="Scan this QR code to present this credential"
                               FontSize="12"
                               Opacity="0.7"
                               HorizontalOptions="Center"/>

                        <!-- Placeholder for QR Code -->
                        <Frame Padding="16"
                               CornerRadius="8"
                               BackgroundColor="#F5F5F5"
                               HasShadow="False"
                               WidthRequest="200"
                               HeightRequest="200"
                               HorizontalOptions="Center">
                            <Label Text="QR Code"
                                   FontSize="14"
                                   Opacity="0.5"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"/>
                            <!-- TODO: Integrate ZXing.Net.Maui for actual QR code generation -->
                        </Frame>

                        <Label Text="{Binding QrCodeData}"
                               FontSize="10"
                               Opacity="0.5"
                               HorizontalOptions="Center"
                               LineBreakMode="CharacterWrap"/>
                    </VerticalStackLayout>
                </Frame>

                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,16,0,0">
                    <Button Grid.Column="0"
                            Text="Revoke"
                            BackgroundColor="#F44336"
                            TextColor="White"
                            Command="{Binding RevokeCredentialCommand}"
                            IsEnabled="{Binding CanRevoke}"/>

                    <Button Grid.Column="1"
                            Text="Suspend"
                            BackgroundColor="#FF9800"
                            TextColor="White"
                            Command="{Binding SuspendCredentialCommand}"
                            IsEnabled="{Binding CanSuspend}"/>
                </Grid>

                <Button Text="Share Credential"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        Command="{Binding ShareCredentialCommand}"/>

            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
